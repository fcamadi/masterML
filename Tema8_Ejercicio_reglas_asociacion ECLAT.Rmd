---
title: "Tema8_Ejercicio_reglas_asociacion_ECLAT"
author: "Fran Camacho"
date: "2025-03-13"
output:
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Tema 8 - Ejercicio Reglas de Asociación (Usando ECLAT en lugar de Apriori)

Utilizando el dataset IncomeESL incluido con la librería arules, se pide generar reglas de asociación.

Para ello, previamente deberá depurar el dataset. En particular:

- Revisar que no haya valores omitidos.
- Transformar los factores en valores numéricos. ← no es necesario!!!
- Una vez depurado el dataset, crear la matriz de transacciones usando la función transactions.

A la hora de ejecutar el algoritmo para obtener las reglas, no olvide establecer
los valores de los parámetros de la función apriori, justificando el motivo de su
elección.

Por último, elabore un breve informe resumiendo las reglas obtenidas y analizando su significado.


## Paso 1: Carga de los datos

```{r}
if (!require(arules)) install.packages('arules', dependencies = T)
library(arules) 

# to plot rules we use package arulesViz
if (!require(arulesViz)) {
  # package graph -and other packages too- must be installed first (and it is not available anymore in CRAN)
  if (!require("BiocManager", quietly = TRUE)) {
    install.packages("BiocManager")
    BiocManager::install("Rgraphviz")
    BiocManager::install("graph")
  }
  install.packages('arulesViz', dependencies = T)
}

data("IncomeESL")
#data("Income")
```


Descripción de las variables del dataset:

https://rdrr.io/cran/arules/man/Income.html

income:
    an ordered factor with levels: ⁠[0,10)⁠ < ⁠[10,15)⁠ < ⁠[15,20)⁠ < ⁠[20,25)⁠ < ⁠[25,30)⁠ < ⁠[30,40)⁠ < ⁠[40,50)⁠ < ⁠[50,75)⁠ < ⁠75+⁠

sex:
    a factor with levels: male female

marital status:
    a factor with levels: married cohabitation divorced widowed single

age:
    an ordered factor with levels: 14-17 < 18-24 < 25-34 < 35-44 < 45-54 < 55-64 < ⁠65+⁠

education:
    an ordered factor with levels: grade <9 < ⁠grades 9-11⁠ < ⁠high school graduate⁠ < college (1-3 years) < ⁠college graduate⁠ < ⁠graduate study⁠

occupation:
    a factor with levels: professional/managerial sales laborer clerical/service homemaker student military retired unemployed

years in bay area:
    an ordered factor with levels: ⁠<1⁠ < 1-3 < 4-6 < 7-10 < ⁠>10⁠

dual incomes:
    a factor with levels: ⁠not married⁠ yes no

number in household:
    an ordered factor with levels: 1 < 2 < 3 < 4 < 5 < 6 < 7 < 8 < ⁠9+⁠

number of children:
    an ordered factor with levels: 0 < 1 < 2 < 3 < 4 < 5 < 6 < 7 < 8 < ⁠9+⁠

householder status:
    a factor with levels: own, rent, ⁠live with parents/family⁠

type of home:
    a factor with levels: house condominium apartment mobile Home other

ethnic classification:
    a factor with levels: ⁠american indian,⁠ asian black ⁠east indian⁠ hispanic ⁠pacific islander⁠ white other
    
language in home:
    a factor with levels: english spanish other



## Paso 2: Explorar y preparar los datos

```{r}
income_raw <- IncomeESL
```


```{r}
#structure
str(income_raw)
```


Nos quedamos con las observaciones que estén completas:

```{r}
# only complete observations
income_complete <- income_raw[complete.cases(income_raw), ]
```


Y obtenemos las transacciones con ellas:


```{r}
# get transactions
income_transac <- transactions(income_complete)
```


Estructura y sumario de las transacciones:

```{r}
#See the structure
str(income_transac)
```

Resumen estadístico

```{r}
#See the structure
summary(income_transac)
```

La matriz dispersa tiene 6876 filas y 84 columnas. 
Al no tratarse de un problema como el de la cesta de la compra, y al tener las filas originales todas 14 valores por 
haber eliminado las filas que tenían valores nulos, todas las transacciones tienen 14 valores.
La densidad es el 16.67%.
(No soy sociólogo, pero los items más frecuentes, dan una idea bastante clara de la población de la muestra).

Examinamos un par de transacciones con "inspect":

```{r}
inspect(income_transac[1:2])
```



### Visualización de los datos


(Ver notebook con la versión Apriori).


## Paso 3: Entrenamiento del modelo


Vamos a probar primero con los valores por defecto:


```{r}
  income_items_eclat <- eclat(income_transac)
```
Con los parámetros por defecto (soporte 0.1), se obtienen 1204 itemsets.

Vamos a aumentar tanto el soporte como la confianza requeridas:

```{r}
#income_items_eclat <- eclat(income_transac, parameter = list(support = 0.25, minlen = 2))  # confidence = 0.5
income_items_eclat_02 <- eclat(income_transac, parameter = list(support = 0.2, minlen = 2))  # confidence = 0.5
```

Ahora obtenemos 189 itemsets:

```{r}
inspect(income_items_eclat_02)
```

Obtenemos las reglas de esos 2 itemsets:

```{r}
income_rules_eclat <- ruleInduction(income_items_eclat, confidence = 0.9)

income_rules_eclat
```


```{r}
income_rules_eclat_02 <- ruleInduction(x=income_items_eclat_02, transactions=income_transac, confidence = 0.8)

income_rules_eclat_02
```



```{r}
inspect(sort(income_rules_eclat_02, by = "lift"))
```

De todas maneras, mejor hacemos el mismo tratamiento de los ingresos que con Apriori:


```{r}
income_complete["income3levels"] <- income_complete["income"]
levels(income_complete[["income3levels"]]) <- c("0-20k$","0-20k$","0-20k$","20k-50k$","20k-50k$","20k-50k$","20k-50k$","50k+","50k+")
#test
income_complete[0:5,c("income","income3levels")]
```
```{r}
# remove income variable with 9 levels
income3L_complete <- income_complete[,-1]
```


Y obtenemos las transacciones con este dataframe

```{r}
# get transactions
income3L_transac <- transactions(income3L_complete)
```



```{r}
income3L_items_eclat_02 <- eclat(income3L_transac, parameter = list(support = 0.2, minlen = 2))
#income3L_items_eclat <- eclat(income3L_transac)
```
```{r}
#inspect(income_items3L_eclat)
inspect(sort(income3L_items_eclat, by = "count")[1:100])
```


```{r}
#income3L_rules_eclat_02 <- ruleInduction(x=income3L_items_eclat_02, transactions=income3L_transac, confidence = 0.9)
income3L_rules_eclat_02 <- ruleInduction(income3L_items_eclat_02)
income3L_rules_eclat_02
```


```{r}
inspect(sort(income3L_rules_eclat_02, by = "lift")[1:100])
```


